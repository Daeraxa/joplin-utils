import{C as e,k as t,j as r,B as s,l as o,m as i}from"./vendor.a6a3bb3d.js";import{f as n,n as a,u as c}from"./index.esm.13361365.js";import{s as l,j as m,a as p,i as d}from"./joplinApiGenerator.53394404.js";import{P as u}from"./PromiseUtil.44f15fd4.js";import{f}from"./immer.esm.6f40434d.js";import"./index.52cfdde8.js";const h=new class{constructor(e){this.config=e}getUnusedResource(){return u.warpOnEvent((async e=>{const t=await l.pageToAllList(this.config.resourceApi.list.bind(this.config.resourceApi),{fields:["id","title","mime"]});let r=0;return await n.filter(t,a((async s=>{const o=!(await this.checkUsed(s.id));return e.process({title:s.title,all:t.length,rate:r++}),o}),10))}))}async checkUsed(e){return(await this.config.searchApi.search({query:`"](:/${e})"`})).items.length>0}}(m);const g=function(e){const t=e();return e=>`http://localhost:${null==t?void 0:t.port}/resources/${e}/file?token=${null==t?void 0:t.token}`}((()=>p(localStorage).settings));export default()=>{const[n,a]=e.exports.useState([]),[l,p]=e.exports.useState(""),[u,x]=c((async()=>{try{const e=await h.getUnusedResource().on("process",(e=>{p(`[${e.rate}/${e.all}] 正在检查资源 ${e.title}`)}));console.log("list: ",e),a(e)}catch(e){t.error("请检查 joplin token/port 配置")}}));return e.exports.createElement(r,null,e.exports.createElement("h2",null,"检查未使用的资源"),e.exports.createElement(s,{onClick:x},"检查"),e.exports.createElement(o,{dataSource:n,locale:{emptyText:"没有找到任何未使用的附件资源"},renderItem:t=>e.exports.createElement(o.Item,{key:t.id,actions:[e.exports.createElement(s,{onClick:()=>async function(e){a(f((t=>t.filter((t=>t.id!==e))))),await m.resourceApi.remove(e)}(t.id)},"删除"),e.exports.createElement(s,{onClick:()=>async function(e){await d(g(e))}(t.id)},"下载")],extra:t.mime.startsWith("image/")&&e.exports.createElement(i,{src:g(t.id),width:300})},e.exports.createElement(o.Item.Meta,{title:t.title})),loading:{spinning:u.loading,tip:l}}))};
